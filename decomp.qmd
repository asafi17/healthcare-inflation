---
title: ''
author: 'Aryan Safi and Kelli Marquardt'
date: today
format: html
editor: visual
code-fold: true
execute: 
  warning: false
  message: false
toc: true
embed-resources: true
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
  fig.width = 12,   # width in inches
  fig.height = 6,  # height in inches
  echo = TRUE,     # show code by default
  warning = FALSE, # hide warnings
  message = FALSE  # hide messages
)
# read in the population data from ipums
pacman::p_load(here,
               tidyverse,
               data.table,
               importhaver,
               Haver,
               readxl,
               fredr)

# set theme 
theme_set(
  theme_minimal() +
    theme(
      plot.title = element_text(size = 22, face = 'bold'),
      plot.subtitle = element_text(size = 20),
      legend.title = element_text(size = 16),
      legend.text = element_text(size = 14),
      legend.position = 'bottom',
      axis.text = element_text(size = 13),
      axis.title = element_text(size = 18),
      plot.caption = element_text(size = 12),
      axis.line = element_line(color = "black"),
      strip.text = element_text(size = 16),
      axis.ticks = element_line(size = 1.01)
    )
)

```

## Inflation

Inflation is typically measured as the percentage change in a price index over time. A price index (CPI or PCEPI) is a weighted average of prices:

$$
P_t = \sum_i w_i \times p_{i,t}
$$

| Object    | Definition                           |
|-----------|--------------------------------------|
| $w_i$     | weight for item/service $i$          |
| $p_{i,t}$ | the price of item/service $i$ at $t$ |

**Inflation** is then:

$$
\pi_t = \frac{P_t - P_{t-k}}{P_{t-k}}
$$

and $k$ is typically 12 indicating the year over year inflation in prices provided monthly.

## Decomposition into weights and prices

To decompose inflation into (i) prices and (ii) weights, we have two options:

### Laspeyres-style (base period weights)

$$
\Delta P_t^L = \underbrace{\sum_i w_{i,t-k} \times \Delta p_i}_{\text{Price Component}} + \underbrace{\sum_i \Delta w_i \times p_{i, t}}_{\text{Weight Component}}
$$

### Paasche-style (current period weights)

$$
\Delta P_{t-k,t}^P = \underbrace{\sum_i w_{i,t} \times \Delta p_i}_{\text{Price Component}} + \underbrace{\sum_i \Delta w_i \times p_{i, t-k}}_{\text{Weight Component}}
$$

| Term         | Definition             |
|--------------|------------------------|
| $\Delta p_i$ | $p_{i,t} - p_{i, t-k}$ |
| $\Delta w_i$ | $w_{i,t} - w_{i, t-k}$ |

## Walkthrough Example

### The Data

Suppose we have the following healthcare sector with just two services: Medicare and Private

| Type            | Period 0 | Period 1 |
|-----------------|----------|----------|
| Medicare Price  | 10       | 12       |
| Private Price   | 5        | 8        |
| Medicare Weight | 0.7      | 0.6      |
| Private Weight  | 0.3      | 0.4      |

Notice that both prices rose, but the weights shifted toward private insurance.

### Laspeyres Decomposition

$$
\underbrace{0.7 * (12-10)}_{\text{Medicare}} + \underbrace{0.3 * (8-5)}_{\text{Private}} = 2.3
\tag{Price Component}
$$

$$
\underbrace{12 * (0.6-0.7)}_{\text{Medicare}} + \underbrace{8 * (0.4-0.3)}_{\text{Private}} = -0.4
\tag{Weight Component}
$$

$$
2.3 + -0.4 = \boxed{1.9}
\tag{Total Change}
$$

We can verify this is true by computing inflation directly. We compute he price index in each period and then calculate the difference.

$$
P_0 = 0.7 * 10 + 0.3*5 = 8.5
$$

$$
P_1 = 0.6 * 12 + 0.4 * 8 = 10.4
$$

$$
\Delta P_{0,1} = 10.4 - 8.5 = \boxed{1.9}
$$

Verified!

### Paasche Decomposition

$$
\underbrace{0.6 * (12-10)}_{\text{Medicare}} + \underbrace{0.4 * (8-5)}_{\text{Private}} = 2.4
\tag{Price Component}
$$

$$
\underbrace{10 * (0.6-0.7)}_{\text{Medicare}} + \underbrace{5 * (0.4-0.3)}_{\text{Private}} = -0.5
\tag{Weight Component}
$$

$$
2.4 + (-0.5) = \boxed{1.9}
\tag{Total Change}
$$

Same change!

### Summary

|   | Laspeyres-style | Paasche-style | Interpretation |
|------------------|------------------|------------------|------------------|
| Price Component | +2.3 | +2.4 | If consumers had kept their baskets fixed each period, the index would have risen by this much |
| Weight Component | -0.4 | -0.5 | Consumers shifted toward Private insurance. This is the "substitution" effect. This partially offset price increases. |
| **Total** | +1.9 | +1.9 | Total change in the price index between $t-k$ and $t$ |

### Key Conceptual Differences

| Type | Laspeyres | Paasche |
|-------------------------------|---------------------|---------------------|
| Price effect evaluated at | Old weights | New weights |
| Weight effect evaluated at | New prices | Old prices |
| Emphasizes | What inflation *would have been* without behavioral change | What inflation *was experienced* given consumption behavior |

For our project, Laspeyres is useful if we're trying to answer: "How much did hosptial input cost rise, holding service mix constant?" - isolating pure cost pressures. Paasche might be useful if we're asking "Given how hospitals changed their mix, what drove observed spending growth?" - capturing the realized experience.

### By-Payer Decomposition

Note, we can also take the work we have done to aggregate by **payer type**. Recall the two expressions we created for the **Laspeyres** Decomposition as an example.

::: callout-note
**Recall** $$
\underbrace{0.7 * (12-10)}_{\text{Medicare}} + \underbrace{0.3 * (8-5)}_{\text{Private}} = 2.3
\tag{Price Component}
$$

$$
\underbrace{12 * (0.6-0.7)}_{\text{Medicare}} + \underbrace{8 * (0.4-0.3)}_{\text{Private}} = -0.4
\tag{Weight Component}
$$
:::

$$
\underbrace{0.7 * (12-10)}_{\text{Medicare Price}} + \underbrace{12 * (0.6-0.7)}_{\text{Medicare Weight}} = 0.2
\tag{Medicare Component}
$$

$$
\underbrace{0.3 * (8-5)}_{\text{Private Price}} + \underbrace{8 * (0.4-0.3)}_{\text{Private Weight}} = 1.7
\tag{Private Component}
$$

And finally, we can verify that these also sum to the total inflation.

$$
1.7 + 0.2 = \boxed{1.9}
$$

## Industry-Based Decomposition of Hospital Inflation

### Producer Price Index (PPI) Data

```{r read-ppi}
# read action economics consensus estimate
ppi = import_haver(series = c("R62211A2@PPIR", 
                              "R62211A4@PPIR",
                              "R62211A6@PPIR"),eop = F) |> 
  rename(ppi_Medicare = r62211a2,
         ppi_Medicaid = r62211a4,
         ppi_Other = r62211a6) 

ppi |> 
  pivot_longer(
    cols = !date, 
    names_to = 'Series', 
    values_to = 'Value'
  ) |> 
  mutate(Series = str_replace_all(Series, 'ppi_', '')) |> 
  ggplot(aes(x = date, color = Series, y = Value)) + 
  # geom_point() + 
  geom_line() + 
  labs(
    y = 'Producer Price Index - Industry Based',
    x = 'Date'
  ) + 
  scale_color_manual(values = ggpubr::get_palette('jco', 3))

DT::datatable(ppi, caption = 'Producer Price Index (Haver)',
              rownames = F, 
              extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip', 
                buttons = c('copy')
              ))


```

### Industry-Based Expenditure Shares

We will read the expenditure share data from the link [CMS NHEA](https://www.cms.gov/files/zip/nhe-tables.zip). Since the PCE Price Index does not publish expenditure shares by payer type, it is necessary to obtain weights from elsewhere. These will be found in the Center for Medicaid and Medicare Services (CMS) National Health Expenditure Accounts (NHEA) tables published online. You can find the relevant table at this link [CMS NHEA](https://www.cms.gov/files/zip/nhe-tables.zip). After downloading, we will read Table 7 which contains the expenditure shares by payer type. From this table, we will create the following variables:

-   `Medicaid` = G5:G32\
-   `Medicare` = F5:F32\
-   `Other` = C5:C32 + E5:E32 + H5:H32 + I5:I32 = Out of Pocket Payers + Private Health Insurance + Other Health Insurance + Other Third Party Payers

We create the `Other` variable to match the "Private and all other patients" designation of the data series with Haver Code `R62211A6.` We verify that the `total` column (B5:B32) is the sum total of these 3 categories (up to rounding error). We re-calculate this `total` value by summing the 3 variables above to ensure that the expenditure shares of each payer-type sum to 1.

```{r read-industry-expenditures}
# check to see if the directory exists
if (!dir.exists(here('data/cms'))) {
  dir.create(here('data/cms'))
}

# check to see if the file is downloaded
if (!file.exists(here('data/cms/nhe-tables.zip'))) {
  download.file(
    url = 'https://www.cms.gov/files/zip/nhe-tables.zip',
    destfile = here('data/cms/nhe-tables.zip'),
    mode = 'wb'
  )
  unzip(
    zipfile = here("data/cms", "nhe-tables.zip"),
    exdir   = here("data/cms", "nhe-tables")
  )
}

# read medicare and medicaid expenditures
medicare = readxl::read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'F4:F32', 
                        ) |> 
  as.matrix() |> as.vector()

# read medicare and medicaid expenditures
medicaid = readxl::read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'G4:G32', 
                        ) |> 
  as.matrix() |> as.vector()

# read private 
private = readxl::read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'E4:E32', 
                        ) |> 
  as.matrix() |> 
  as.vector()

# read out of pocket 
oop = readxl::read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'C4:C32', 
                        ) |> 
  as.matrix() |> 
  as.vector()

# read other health insurance 
other_health_ins = read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'H4:H32', 
                        ) |> 
  as.matrix() |> 
  as.vector()

# read other 3rd party payers 
third_party = read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                        range = 'I4:I32', 
                        ) |> 
  as.matrix() |> 
  as.vector()

# combine all of these not-medicare, not-medicaid variables into one "other" category 
other = private + oop + other_health_ins + third_party


# read total expenditures 
total = read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                     range = 'B4:B32') |> 
    as.matrix() |> 
  as.vector()


# store year 
year = read_xlsx(here('data/cms/nhe-tables/Table 07 Hospital Care Expenditures.xlsx'), 
                     range = 'A4:A32')[,1] |> 
  as.matrix() |> 
  as.vector()

# combine into one data frame
exp = data.frame(
  year = year, 
  total = total, 
  Medicare = medicare, 
  Medicaid = medicaid, 
  Other = other
) |> 
  mutate(
    across(where(is.numeric), ~ round(., 1))
  ) |> 
  mutate(
    total = Medicare + Medicaid + Other
  ) |> 
  filter(year >= 2000)

# note: the total matches them to rounding error. 

# plot 
exp |> 
  select(-total) |>
  pivot_longer(
    cols = !year, 
    names_to = 'Series', 
    values_to = 'Value'
  ) |> 
  ggplot(aes(x = year, color = Series, y = Value)) + 
  # geom_point() + 
  geom_line() + 
  labs(
    y = 'Hospital Care Expenditures - Industry Based',
    x = 'Year',
    subtitle = 'Billions $'
  ) + 
  scale_color_manual(values = ggpubr::get_palette('jco', 4))

DT::datatable(exp, caption = 'Hospital Care Expenditures (Billions)', rownames = F, 
              extensions = 'Buttons',
              options = list(
                dom = 'Bfrtip', 
                buttons = c('copy')
              ))

rm(list = setdiff(ls(), c('exp', 'ppi')))
```

The expenditure data are annual here. We will change this to monthly data by creating a sequence of monthly dates from January 2000 to December 2024, storing the `year` of each month, and merging the annual expenditure data using this `year` variable.

```{r}
exp_monthly = data.frame(
  date = seq.Date(as.Date('2000-01-01'), as.Date('2024-12-01'), by = 'month')
) |> 
  mutate(
    year = year(date)
  ) |> 
  left_join(exp, by = 'year')

exp_monthly |> 
  select(-total, -year) |> 
  pivot_longer(
    cols = !date, 
    names_to = 'Series', 
    values_to = 'Value'
  ) |> 
  ggplot(aes(x = date, color = Series, y = Value)) + 
  # geom_point() + 
  geom_line() + 
  labs(
    y = 'Hospital Care Expenditures - Industry Based',
    x = 'Month',
    subtitle = 'Billions $'
  ) + 
  scale_color_manual(values = ggpubr::get_palette('jco', 3))
```

Next, we compute the expenditure shares of each category.

```{r}
exp_monthly = exp_monthly |> 
  mutate(
    shr_Medicare = Medicare / total, 
    shr_Medicaid = Medicaid/total, 
    shr_Other = Other / total
  )

exp_monthly |> 
  select(date, contains('shr')) |> 
  pivot_longer(
    cols = !date, 
    names_to = 'Series', 
    values_to = 'Value'
  ) |> 
  mutate(
    Series = str_replace_all(Series, 'shr_', '')
  ) |> 
  ggplot(aes(x = date, color = Series, y = Value)) + 
  # geom_point() + 
  geom_line() + 
  labs(
    y = 'Hospital Share Expenditures - Industry Based',
    x = 'Month'
  ) + 
  scale_color_manual(values = ggpubr::get_palette('jco', 3))
```

### Compute Overall Hospital Inflation

```{r}
# convert ppi to long format 
ppi_long = ppi |> 
  pivot_longer(
    cols = !date, 
    names_to = 'payerType', 
    values_to = 'ppi'
  ) |> 
  mutate(
    payerType = str_replace_all(payerType, 'ppi_', '')
  )

# convert exp to long format 
exp_monthly_long = exp_monthly |> 
  select(date, contains('shr')) |> 
  pivot_longer(
    cols = !date, 
    names_to = 'payerType', 
    values_to = 'wt'
  ) |> 
  mutate(
    payerType = str_replace_all(payerType, 'shr_', '')
  )

# combine the data 
inflation = inner_join(exp_monthly_long, ppi_long, by = c('date', 'payerType')) |> 
  # compute overall inflation
  group_by(date) |> 
  summarise(
    P_t = sum(wt*ppi)
  ) |> 
  ungroup() |> 
  mutate(
    pi_t = (P_t - lag(P_t, 12)) / lag(P_t, 12)
  )

ggplot(inflation, aes(x = date, y = 100*pi_t)) +
  geom_line() +
  geom_hline(yintercept = 100*mean(inflation$pi_t, na.rm = T), linetype = 'dashed') + 
  labs(
    x = 'Month',
    y = 'Hospital Inflation (% YoY)'
  )

```


### Laspeyres Decomposition by Weights and Prices

```{r}
legend = ggpubr::get_palette('jco', 2)
names(legend) = c('Price Component', 'Weight Component')
inner_join(exp_monthly_long, ppi_long, by = c('date', 'payerType')) |>
  # get price component of the laspeyres-style decomp
  group_by(payerType) |>
  mutate(
    price_component_L = lag(wt, 12) * (ppi - lag(ppi, 12)),
    weight_component_L = ppi * (wt - lag(wt, 12))
  ) |>
  ungroup() |>
  group_by(date) |>
  summarise(
    `Price Component` = sum(price_component_L, na.rm = T),
    `Weight Component` = sum(weight_component_L, na.rm = T)
  ) |>
  ungroup() |>
  # normalize by P_{t-k} to convert from level change to percentage change
  left_join(inflation, by = 'date') |>
  mutate(
    `Price Component`  = `Price Component`  / lag(P_t, 12) * 100,
    `Weight Component` = `Weight Component` / lag(P_t, 12) * 100,
    pi_t = pi_t * 100
  ) |> 
  pivot_longer(
    cols = c(`Price Component`, `Weight Component`),
    names_to = 'Component',
    values_to = 'Contribution'
  ) |>
  # check the inflation total matches pi_t
  group_by(date) |> 
  mutate(check = sum(Contribution)) |> 
  ungroup() |>
  mutate(
    flag = ifelse(round(check - pi_t, 5) == 0, F, T)
  ) |> 
  filter(date >= '2001-01-01') |> 
  # summary()
  ggplot(aes(x = date)) +
  geom_col(aes(y = Contribution, color = Component, fill = Component), alpha = .7) +
  geom_point(aes(y = pi_t)) +
  geom_line(aes(y = pi_t), linetype = 'solid') +
  geom_hline(yintercept = 0, linetype = 'solid') + 
  scale_color_manual(values = legend) +
  scale_fill_manual(values = legend) + 
  labs(
    x = '', 
    y = 'Percentage Point'
  )


```


### Laspeyres Decomposition by Payer Type

```{r}
legend = ggpubr::get_palette('jco', 3)
names(legend) = c('Other', 'Medicare', 'Medicaid')
inner_join(exp_monthly_long, ppi_long, by = c('date', 'payerType')) |>
  # get price component of the laspeyres-style decomp
  group_by(payerType) |>
  mutate(
    price_component_L = lag(wt, 12) * (ppi - lag(ppi, 12)),
    weight_component_L = ppi * (wt - lag(wt, 12))
  ) |>
  ungroup() |> 
  # store the contribution from each 
  mutate(
    contribution_L = price_component_L + weight_component_L
  ) |> 
  select(
    date, payerType, contribution_L
  ) |> 
    arrange(payerType, date) |> 
  # normalize by P_{t-k} to convert from level change to percentage change
  left_join(inflation, by = 'date') |> 
  group_by(payerType) |> 
  mutate(
    Contribution = contribution_L / lag(P_t, 12) * 100,
    pi_t = pi_t * 100
  ) |>
  ungroup() |> 
  # check the inflation total matches pi_t
  group_by(date) |> 
  mutate(check = sum(Contribution)) |> 
  ungroup() |> 
  mutate(
    flag = ifelse(round(check - pi_t, 5) == 0, F, T)
  ) |> 
  filter(date >= '2001-01-01') |>
  ggplot(aes(x = date)) +
  geom_col(aes(y = Contribution, color = payerType, fill = payerType), alpha = .7) +
  geom_point(aes(y = pi_t)) +
  geom_line(aes(y = pi_t), linetype = 'solid') +
  geom_hline(yintercept = 0, linetype = 'solid') + 
  scale_color_manual(values = legend) +
  scale_fill_manual(values = legend) + 
  labs(
    x = '', 
    y = 'Percentage Points',
    fill = 'Payer Type', 
    color = 'Payer Type'
  )


```



### Paasche Decomposition by Weights and Prices

```{r}
legend = ggpubr::get_palette('jco', 2)
names(legend) = c('Price Component', 'Weight Component')
inner_join(exp_monthly_long, ppi_long, by = c('date', 'payerType')) |>
  # get price component of the laspeyres-style decomp
  group_by(payerType) |>
  mutate(
    price_component_P = wt * (ppi - lag(ppi, 12)),
    weight_component_P = lag(ppi, 12) * (wt - lag(wt, 12))
  ) |>
  ungroup() |>
  group_by(date) |>
  summarise(
    `Price Component` = sum(price_component_P, na.rm = T),
    `Weight Component` = sum(weight_component_P, na.rm = T)
  ) |>
  ungroup() |>
  # normalize by P_{t-k} to convert from level change to percentage change
  left_join(inflation, by = 'date') |>
  mutate(
    `Price Component`  = `Price Component`  / lag(P_t, 12) * 100,
    `Weight Component` = `Weight Component` / lag(P_t, 12) * 100,
    pi_t = pi_t * 100
  ) |> 
  pivot_longer(
    cols = c(`Price Component`, `Weight Component`),
    names_to = 'Component',
    values_to = 'Contribution'
  ) |>
  # check the inflation total matches pi_t
  group_by(date) |> 
  mutate(check = sum(Contribution)) |> 
  ungroup() |>
  mutate(
    flag = ifelse(round(check - pi_t, 5) == 0, F, T)
  ) |> 
  filter(date >= '2001-01-01') |> 
  # summary()
  ggplot(aes(x = date)) +
  geom_col(aes(y = Contribution, color = Component, fill = Component), alpha = .7) +
  geom_point(aes(y = pi_t)) +
  geom_line(aes(y = pi_t), linetype = 'solid') +
  geom_hline(yintercept = 0, linetype = 'solid') + 
  scale_color_manual(values = legend) +
  scale_fill_manual(values = legend) + 
  labs(
    x = '', 
    y = 'Percentage Point'
  )


```




### Paasche Decomposition by Payer Type

```{r}
legend = ggpubr::get_palette('jco', 3)
names(legend) = c('Other', 'Medicare', 'Medicaid')
inner_join(exp_monthly_long, ppi_long, by = c('date', 'payerType')) |>
  # get price component of the laspeyres-style decomp
  group_by(payerType) |>
  mutate(
    price_component_P = wt * (ppi - lag(ppi, 12)),
    weight_component_P = lag(ppi, 12) * (wt - lag(wt, 12))
  ) |>
  ungroup() |> 
  # store the contribution from each 
  mutate(
    contribution_P = price_component_P + weight_component_P
  ) |> 
  select(
    date, payerType, contribution_P
  ) |> 
    arrange(payerType, date) |> 
  # normalize by P_{t-k} to convert from level change to percentage change
  left_join(inflation, by = 'date') |> 
  group_by(payerType) |> 
  mutate(
    Contribution = contribution_P / lag(P_t, 12) * 100,
    pi_t = pi_t * 100
  ) |>
  ungroup() |> 
  # check the inflation total matches pi_t
  group_by(date) |> 
  mutate(check = sum(Contribution)) |> 
  ungroup() |> 
  mutate(
    flag = ifelse(round(check - pi_t, 5) == 0, F, T)
  ) |> 
  filter(date >= '2001-01-01') |>
  ggplot(aes(x = date)) +
  geom_col(aes(y = Contribution, color = payerType, fill = payerType), alpha = .7) +
  geom_point(aes(y = pi_t)) +
  geom_line(aes(y = pi_t), linetype = 'solid') +
  geom_hline(yintercept = 0, linetype = 'solid') + 
  scale_color_manual(values = legend) +
  scale_fill_manual(values = legend) + 
  labs(
    x = '', 
    y = 'Percentage Points',
    fill = 'Payer Type', 
    color = 'Payer Type'
  )


```